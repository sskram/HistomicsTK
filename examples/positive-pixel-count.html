

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Positive Pixel Count &mdash; HistomicsTK 0.1.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Contributing" href="../contributing.html" />
    <link rel="prev" title="Nuclei Segmentation" href="nuclei-segmentation.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> HistomicsTK
          

          
          </a>

          
            
            
              <div class="version">
                0.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api-docs.html">API Documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="color-deconvolution.html">Color Deconvolution</a></li>
<li class="toctree-l2"><a class="reference internal" href="nuclei-segmentation.html">Nuclei Segmentation</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Positive Pixel Count</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Analyzing-a-small-image-with-count_image">Analyzing a small image with <code class="docutils literal notranslate"><span class="pre">count_image</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#Analyzing-a-large-image-with-count_slide">Analyzing a large image with <code class="docutils literal notranslate"><span class="pre">count_slide</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Additional-setup">Additional setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#count_slide-on-a-small-region"><code class="docutils literal notranslate"><span class="pre">count_slide</span></code> on a small region</a></li>
<li class="toctree-l4"><a class="reference internal" href="#count_slide-on-a-large-region"><code class="docutils literal notranslate"><span class="pre">count_slide</span></code> on a large region</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#The-CLI">The CLI</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../authors.html">Credits</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">HistomicsTK</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../examples.html">Examples</a> &raquo;</li>
        
      <li>Positive Pixel Count</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/examples/positive-pixel-count.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 8ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="section" id="Positive-Pixel-Count">
<h1>Positive Pixel Count<a class="headerlink" href="#Positive-Pixel-Count" title="Permalink to this headline">Â¶</a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [1]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Configuration and imports of other libraries</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">large_image</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">skimage.io</span>

<span class="c1">#Some nice default configuration for plots</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;image.cmap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [2]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Import and alias positive_pixel_count</span>
<span class="kn">import</span> <span class="nn">histomicstk.segmentation.positive_pixel_count</span> <span class="kn">as</span> <span class="nn">ppc</span>
</pre></div>
</div>
</div>
<div class="section" id="Overview">
<h2>Overview<a class="headerlink" href="#Overview" title="Permalink to this headline">Â¶</a></h2>
<p>Positive pixel count is a routine that classifies pixels by their
position in <a class="reference external" href="https://en.wikipedia.org/wiki/HSL_and_HSV#Hue_and_chroma">HSI Color
Space</a> and
computes statistics based on this classification.</p>
<p>HistomicsTK has two main functions for positive pixel counting,
<code class="docutils literal notranslate"><span class="pre">count_slide</span></code> and <code class="docutils literal notranslate"><span class="pre">count_image</span></code>, both of which live in the
<code class="docutils literal notranslate"><span class="pre">histomicstk.segmentation.positive_pixel_count</span></code> module (imported in
this notebook as simply <code class="docutils literal notranslate"><span class="pre">ppc</span></code>). <code class="docutils literal notranslate"><span class="pre">count_image</span></code> operates on an
in-memory image in a format compatible with NumPyâs <code class="docutils literal notranslate"><span class="pre">ndarray</span></code> type,
and returns both the classification statistics and a label image that
may be useful for visualization or further analysis.</p>
<p><code class="docutils literal notranslate"><span class="pre">count_slide</span></code> accepts a path to an image instead, and while it can
also carry out exactly the same computation as <code class="docutils literal notranslate"><span class="pre">count_image</span></code>, its
advantage lies in its ability to distribute its computation using
<a class="reference external" href="http://dask.pydata.org/en/latest/index.html">Dask</a> and to operate on
images too large to fit in memory. This ability comes at a cost â to
enable it, the generation of the label image must be disabled. (For the
curious, the necessary underlying support for writing large images a
tile at a time is lacking.) The HistomicsTK CLI <code class="docutils literal notranslate"><span class="pre">PositivePixelCount</span></code>
is a wrapper around this function.</p>
<p>The rest of this example is subdivided, in order, into <code class="docutils literal notranslate"><span class="pre">count_image</span></code>
and <code class="docutils literal notranslate"><span class="pre">count_slide</span></code> examples, followed by a CLI example.</p>
</div>
<div class="section" id="Analyzing-a-small-image-with-count_image">
<h2>Analyzing a small image with <code class="docutils literal notranslate"><span class="pre">count_image</span></code><a class="headerlink" href="#Analyzing-a-small-image-with-count_image" title="Permalink to this headline">Â¶</a></h2>
<p>We start with <code class="docutils literal notranslate"><span class="pre">count_image</span></code>. The image we will look at is small and
can be analyzed quickly.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [3]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">image_url</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;https://data.kitware.com/api/v1/file/&#39;</span>
             <span class="s1">&#39;598b71ee8d777f7d33e9c1d4/download&#39;</span><span class="p">)</span>  <span class="c1"># DAB.png</span>

<span class="n">im_input</span> <span class="o">=</span> <span class="n">skimage</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">image_url</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Input image&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im_input</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Input image
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_positive-pixel-count_5_1.png" src="../_images/examples_positive-pixel-count_5_1.png" />
</div>
</div>
<p>With a helper function, it becomes reasonable to use <code class="docutils literal notranslate"><span class="pre">count_image</span></code>
interactively to explore parameter values. A more advanced analysis
might also look at the HSI values directly.</p>
<p>Here, we show briefly how one can use the helper function
<code class="docutils literal notranslate"><span class="pre">count_and_label</span></code> defined below.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [4]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">count_and_label</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="s2">&quot;Compute the label image with count_image, and then display it&quot;</span>
    <span class="n">label_image</span> <span class="o">=</span> <span class="n">ppc</span><span class="o">.</span><span class="n">count_image</span><span class="p">(</span><span class="n">im_input</span><span class="p">,</span> <span class="n">params</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">label_image</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>To start out, weâll pick a set of parameters. The HSI color space used
by the routines is defined to use values in the range [0,1].</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [5]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">template_params</span> <span class="o">=</span> <span class="n">ppc</span><span class="o">.</span><span class="n">Parameters</span><span class="p">(</span>
    <span class="n">hue_value</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">hue_width</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span>
    <span class="n">saturation_minimum</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">intensity_upper_limit</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
    <span class="n">intensity_weak_threshold</span><span class="o">=</span><span class="mf">0.65</span><span class="p">,</span>
    <span class="n">intensity_strong_threshold</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span>
    <span class="n">intensity_lower_limit</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [6]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">count_and_label</span><span class="p">(</span><span class="n">template_params</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_positive-pixel-count_10_0.png" src="../_images/examples_positive-pixel-count_10_0.png" />
</div>
</div>
<p>Internally, the label values are conveniently increasing, regularly
spaced integers. Black is therefore background / negative, dark gray is
weak positive, light gray is positive, and white is strong positive. To
use the label values programmatically, use of the static attributes of
<code class="docutils literal notranslate"><span class="pre">ppc.Labels</span></code> â <code class="docutils literal notranslate"><span class="pre">.NEGATIVE</span></code>, <code class="docutils literal notranslate"><span class="pre">.WEAK</span></code>, <code class="docutils literal notranslate"><span class="pre">.PLAIN</span></code>, and <code class="docutils literal notranslate"><span class="pre">.STRONG</span></code> â
is recommended.</p>
<p>This does a reasonably good job aleady, but letâs see what happens if we
shift the hue center a bit. Since <code class="docutils literal notranslate"><span class="pre">Parameters</span></code> is a
<code class="docutils literal notranslate"><span class="pre">collections.namedtuple</span></code>, we can use its <code class="docutils literal notranslate"><span class="pre">._replace</span></code> method to
substitute a value.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [7]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">count_and_label</span><span class="p">(</span><span class="n">template_params</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">hue_value</span><span class="o">=</span><span class="mf">0.</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_positive-pixel-count_12_0.png" src="../_images/examples_positive-pixel-count_12_0.png" />
</div>
</div>
<p>Here, we see that a number of pixels previously considered positive are
now considered negative, creating holes in visible nuclei. This
indicates that weâve moved the hue range too far.</p>
<p>In any case, we can also view the statistics. Here we use the original
parameter values.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [8]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">stats</span><span class="p">,</span> <span class="n">label_image</span> <span class="o">=</span> <span class="n">ppc</span><span class="o">.</span><span class="n">count_image</span><span class="p">(</span><span class="n">im_input</span><span class="p">,</span> <span class="n">template_params</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">pp_namedtuple</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="s2">&quot;Pretty-print a namedtuple by printing each field on its own line and left-aligning all values&quot;</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">maxlen</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">_fields</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxlen</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">pp_namedtuple</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Output
NumberWeakPositive:                     62163
NumberPositive:                         24459
NumberStrongPositive:                   4948
IntensitySumWeakPositive:               49554.6535948
IntensitySumPositive:                   12907.145098
IntensitySumStrongPositive:             1423.41830065
IntensityAverage:                       0.697665359763
RatioStrongToTotal:                     0.0540351643551
IntensityAverageWeakAndPositive:        0.7210846978
</pre></div></div>
</div>
</div>
<div class="section" id="Analyzing-a-large-image-with-count_slide">
<h2>Analyzing a large image with <code class="docutils literal notranslate"><span class="pre">count_slide</span></code><a class="headerlink" href="#Analyzing-a-large-image-with-count_slide" title="Permalink to this headline">Â¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">count_slide</span></code> has several more parameters than <code class="docutils literal notranslate"><span class="pre">count_image</span></code>.
Besides <code class="docutils literal notranslate"><span class="pre">make_label_image</span></code>, which controls the creation of the label
image as mentioned, there is also <code class="docutils literal notranslate"><span class="pre">region</span></code>, which instructs
<code class="docutils literal notranslate"><span class="pre">count_slide</span></code> to operate on only the specified region of the image.</p>
<p>We will visualize its operation on a small region, and then run it on a
larger region.</p>
<div class="section" id="Additional-setup">
<h3>Additional setup<a class="headerlink" href="#Additional-setup" title="Permalink to this headline">Â¶</a></h3>
<p>First, however, weâll need to download an image and set up Dask. (The
image is 1.630 GiB, so the download takes a while.)</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [9]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Comment this out (or just don&#39;t run it) once you have the file</span>
<span class="o">!</span>curl -OJ <span class="s1">&#39;https://data.kitware.com/api/v1/file/598b5ee88d777f7d33e9c1d1/download&#39;</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 1668M  100 1668M    0     0  1237k      0  0:23:01  0:23:01 --:--:-- 1292k
curl: Saved to filename &#39;TCGA-DX-A6BG-01Z-00-DX2.34763958-0613-4069-9ACC-13D6633FE415.svs&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [10]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Set up a basic configuration.  Change as needed.</span>
<span class="kn">import</span> <span class="nn">dask.distributed</span>

<span class="n">dask</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>Out[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<table style="border: 2px solid white;">
<tr>
<td style="vertical-align: top; border: 0px solid white">
<h3>Client</h3>
<ul>
  <li><b>Scheduler: </b>tcp://127.0.0.1:43767
</ul>
</td>
<td style="vertical-align: top; border: 0px solid white">
<h3>Cluster</h3>
<ul>
  <li><b>Workers: </b>8</li>
  <li><b>Cores: </b>8</li>
  <li><b>Memory: </b>9.74 GB</li>
</ul>
</td>
</tr>
</table></div>
</div>
</div>
<div class="section" id="count_slide-on-a-small-region">
<h3><code class="docutils literal notranslate"><span class="pre">count_slide</span></code> on a small region<a class="headerlink" href="#count_slide-on-a-small-region" title="Permalink to this headline">Â¶</a></h3>
<p>Now we can inspect the image. Weâll first run the calculation to produce
a label image, and then run it again without, allowing parallelization.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [11]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">slide_path</span> <span class="o">=</span> <span class="s1">&#39;TCGA-DX-A6BG-01Z-00-DX2.34763958-0613-4069-9ACC-13D6633FE415.svs&#39;</span>
<span class="n">region</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">left</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mi">35000</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">1600</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">900</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ts</span> <span class="o">=</span> <span class="n">large_image</span><span class="o">.</span><span class="n">getTileSource</span><span class="p">(</span><span class="n">slide_path</span><span class="p">)</span>
<span class="n">im_region</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">getRegion</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n">large_image</span><span class="o">.</span><span class="n">tilesource</span><span class="o">.</span><span class="n">TILE_FORMAT_NUMPY</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">print</span><span class="p">(</span><span class="s2">&quot;The region&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im_region</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-magenta-fg">Using python for large_image caching</span>
The region
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_positive-pixel-count_20_1.png" src="../_images/examples_positive-pixel-count_20_1.png" />
</div>
</div>
<p>Weâll reuse the parameters from before.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [12]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">stats</span><span class="p">,</span> <span class="n">label_image</span> <span class="o">=</span> <span class="n">ppc</span><span class="o">.</span><span class="n">count_slide</span><span class="p">(</span><span class="n">slide_path</span><span class="p">,</span> <span class="n">template_params</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">make_label_image</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">pp_namedtuple</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">label_image</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Output
NumberWeakPositive:                     31591
NumberPositive:                         26850
NumberStrongPositive:                   5582
IntensitySumWeakPositive:               24633.7385621
IntensitySumPositive:                   13946.745098
IntensitySumStrongPositive:             1549.14248366
IntensityAverage:                       0.626800152192
RatioStrongToTotal:                     0.087187417022
IntensityAverageWeakAndPositive:        0.660161250836
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_positive-pixel-count_22_1.png" src="../_images/examples_positive-pixel-count_22_1.png" />
</div>
</div>
<p>The output is about the same quality as before. As the small region used
in the previous section is in fact extracted from another part of this
slide, this is not too surprising.</p>
<p>Weâll now rerun for only the stats, which will make use of Dask.
<code class="docutils literal notranslate"><span class="pre">make_label_image</span></code> defaults to <code class="docutils literal notranslate"><span class="pre">False</span></code>, so we simply omit it here.
For the purposes of illustration, we force <code class="docutils literal notranslate"><span class="pre">tile_grouping</span></code> to 1 to
process each tile in its own task. A larger value, 256, is used as the
default value to reduce the overhead associated with Dask tasks.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [13]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Note that we still return a tuple, though it now has length 1.</span>
<span class="n">stats_dask</span><span class="p">,</span> <span class="o">=</span> <span class="n">ppc</span><span class="o">.</span><span class="n">count_slide</span><span class="p">(</span><span class="n">slide_path</span><span class="p">,</span> <span class="n">template_params</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">tile_grouping</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">pp_namedtuple</span><span class="p">(</span><span class="n">stats_dask</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Output
NumberWeakPositive:                     31591
NumberPositive:                         26850
NumberStrongPositive:                   5582
IntensitySumWeakPositive:               24633.7385621
IntensitySumPositive:                   13946.745098
IntensitySumStrongPositive:             1549.14248366
IntensityAverage:                       0.626800152192
RatioStrongToTotal:                     0.087187417022
IntensityAverageWeakAndPositive:        0.660161250836
</pre></div></div>
</div>
<p>The results are identical up to a tiny amount of floating point error,
as can be seen below:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [14]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">print</span><span class="p">(</span><span class="s2">&quot;stats_dask - stats:&quot;</span><span class="p">)</span>
<span class="n">pp_namedtuple</span><span class="p">(</span><span class="n">ppc</span><span class="o">.</span><span class="n">Output</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">f</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">stats_dask</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">-</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ppc</span><span class="o">.</span><span class="n">Output</span><span class="o">.</span><span class="n">_fields</span><span class="p">}))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
stats_dask - stats:
Output
NumberWeakPositive:                     0
NumberPositive:                         0
NumberStrongPositive:                   0
IntensitySumWeakPositive:               3.63797880709e-12
IntensitySumPositive:                   0.0
IntensitySumStrongPositive:             2.27373675443e-13
IntensityAverage:                       1.11022302463e-16
RatioStrongToTotal:                     0.0
IntensityAverageWeakAndPositive:        1.11022302463e-16
</pre></div></div>
</div>
</div>
<div class="section" id="count_slide-on-a-large-region">
<h3><code class="docutils literal notranslate"><span class="pre">count_slide</span></code> on a large region<a class="headerlink" href="#count_slide-on-a-large-region" title="Permalink to this headline">Â¶</a></h3>
<p>As a better exhibition of <code class="docutils literal notranslate"><span class="pre">count_slide</span></code>âs use of parallelism in
computing statistics, we run it here on a much larger region, 30Kx30K
pixels.</p>
<p>(By leaving out the <code class="docutils literal notranslate"><span class="pre">region</span></code> parameter, <code class="docutils literal notranslate"><span class="pre">count_slide</span></code> will look at
the entire image. At 146Kx79K pixels, this image will cause
<code class="docutils literal notranslate"><span class="pre">count_slide</span></code> to use a lot of memory, potentially enough to require
swap space, without additional configuration of <code class="docutils literal notranslate"><span class="pre">large_image</span></code>âs
caching behavior.)</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [15]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">large_region</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">left</span><span class="o">=</span><span class="mf">60e3</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">30e3</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mf">30e3</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mf">30e3</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">stats</span><span class="p">,</span> <span class="o">=</span> <span class="o">%</span><span class="k">time</span> ppc.count_slide(slide_path, template_params, large_region)

<span class="n">pp_namedtuple</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 1.97 s, sys: 854 ms, total: 2.82 s
Wall time: 39.7 s
Output
NumberWeakPositive:                     8017246
NumberPositive:                         4348294
NumberStrongPositive:                   599706
IntensitySumWeakPositive:               6295544.71895
IntensitySumPositive:                   2316964.78562
IntensitySumStrongPositive:             174806.233987
IntensityAverage:                       0.677759275725
RatioStrongToTotal:                     0.0462548878749
IntensityAverageWeakAndPositive:        0.696492794053
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="The-CLI">
<h2>The CLI<a class="headerlink" href="#The-CLI" title="Permalink to this headline">Â¶</a></h2>
<p>Finally, we briefly demonstrate the use of the CLI. It takes arguments
the same as or equivalent to those of <code class="docutils literal notranslate"><span class="pre">count_slide</span></code>, as well as a
<code class="docutils literal notranslate"><span class="pre">--scheduler_address</span></code> argument that is used to connect to an already
running Dask distributed scheduler if provided.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [16]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pp_namedtuple</span><span class="p">(</span><span class="n">template_params</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Region:&#39;</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Parameters
hue_value:                      0.05
hue_width:                      0.15
saturation_minimum:             0.05
intensity_upper_limit:          0.95
intensity_weak_threshold:       0.65
intensity_strong_threshold:     0.35
intensity_lower_limit:          0.05

Region: {&#39;width&#39;: 1600, &#39;top&#39;: 35000, &#39;height&#39;: 900, &#39;left&#39;: 50000}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [17]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">script</span> sh
# Stats and label image output must be specified via file arguments to
# --returnparameterfile and --outputLabelImage, respectively.
python ../../server/PositivePixelCount/PositivePixelCount.py \
    &#39;TCGA-DX-A6BG-01Z-00-DX2.34763958-0613-4069-9ACC-13D6633FE415.svs&#39; \
    0.05 0.15 0.05 0.95 0.65 0.35 0.05 --region 50000,35000,1600,900 \
    --returnparameterfile stats.txt --outputLabelImage labelImage.png 2&gt;/dev/null
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-magenta-fg">Using python for large_image caching</span>
</pre></div></div>
</div>
<p>Here are the results. Note that, if a label image is output, itâs
colorized according to colors from the
<a class="reference external" href="https://www.ncl.ucar.edu/Document/Graphics/ColorTables/MPL_coolwarm.shtml">coolwarm</a>
color map. White is negative, blue is weak positive, gray is positive,
and red is strong positive.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [18]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">print</span><span class="p">(</span><span class="s2">&quot;stats.txt:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;stats.txt&#39;</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>

<span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">labelImage.png:&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">skimage</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s1">&#39;labelImage.png&#39;</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
stats.txt:
NumberWeakPositive = 31591
NumberPositive = 26850
NumberStrongPositive = 5582
IntensitySumWeakPositive = 24633.7385621
IntensitySumPositive = 13946.745098
IntensitySumStrongPositive = 1549.14248366
IntensityAverage = 0.626800152192
RatioStrongToTotal = 0.087187417022
IntensityAverageWeakAndPositive = 0.660161250836

labelImage.png:
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_positive-pixel-count_33_1.png" src="../_images/examples_positive-pixel-count_33_1.png" />
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../contributing.html" class="btn btn-neutral float-right" title="Contributing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="nuclei-segmentation.html" class="btn btn-neutral" title="Nuclei Segmentation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Kitware, Inc..

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>